name: Test Suite

on:
  push:
    branches: [ develop, feature/* ]
    # Note: master is excluded (deploy.yml handles master)
  pull_request:
    branches: [ master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js LTS
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm run test:run
      
    - name: Generate coverage report
      run: npm run test:coverage
      
    - name: Upload coverage reports as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: coverage/
        retention-days: 30
        
    - name: Generate coverage summary
      run: |
        echo "## ðŸ“Š Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Percentage |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|------------|" >> $GITHUB_STEP_SUMMARY
        
        # Extract coverage percentages from the test output
        npm run test:coverage 2>&1 | grep -E "All files.*%" | head -1 | \
        sed 's/.*|\s*\([0-9.]*\).*|\s*\([0-9.]*\).*|\s*\([0-9.]*\).*|\s*\([0-9.]*\).*/| Statements | \1% |\n| Branches | \2% |\n| Functions | \3% |\n| Lines | \4% |/' >> $GITHUB_STEP_SUMMARY || echo "| Coverage | See artifacts |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“‹ **View detailed coverage report in the artifacts section**" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ” **Download the coverage-reports artifact to view HTML report**" >> $GITHUB_STEP_SUMMARY
