#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Stash unstaged changes to avoid partial formatting issues
STASH_NAME="pre-commit-format-stash"
STASHED=false

# Only stash if there are unstaged changes
if ! git diff --quiet -- .; then
  STASHED=true
  git stash push -k -u -m "$STASH_NAME" --quiet
fi

# Run format check
npm run --silent format:check
FORMAT_STATUS=$?

if [ $FORMAT_STATUS -ne 0 ]; then
  echo "Pre-commit: formatting issues found. Running formatter..."
  npm run --silent format || exit 1
  git add -A
fi

# Restore stashed changes if any
if [ "$STASHED" = true ]; then
  # Apply stash without dropping to preserve work; drop only if apply succeeded
  if git stash apply --quiet "stash^{/$STASH_NAME}"; then
    git stash drop --quiet "stash^{/$STASH_NAME}" || true
  else
    echo "Warning: could not reapply stashed changes automatically. Resolve manually."
  fi
fi

exit 0
